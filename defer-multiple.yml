---
- name: Defer a CVE for 90 days Red Hat Advanced Cluster Security for Kubernetes
  hosts: localhost
  gather_facts: true

  vars_files:
  - vault

  vars:
    acs_host: "{{ vaulted_acs_host }}"
    acs_token: "{{ vaulted_acs_token }}"

  tasks:
    - name: Defer the CVEs for 90 days
      uri:
        url: https://{{ acs_host }}/v1/cve/requests/defer
        headers:
          Authorization: "Bearer {{ acs_token }}"
        method: POST
        body: {"cve": "{{ item }}", "scope": {"globalScope": {}},"comment": "{{ comment }}","expiresWhenFixed": true, "expiresOn": "{{ lookup('pipe', 'date +%Y-%m-%dT%H:%M:%SZ -d \"+{{ days }} days\"') }}" }
        force_basic_auth: yes
        status_code: 200
        body_format: json
        validate_certs: false
      loop: "{{ cves.split('\n') | cve2rhsa }}"
      no_log: false
      changed_when: true
